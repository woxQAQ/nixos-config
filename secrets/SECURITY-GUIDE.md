# SSH 密钥安全管理指南

## 🚨 为什么不同系统的用户应该使用不同的 SSH 密钥？

### 1. **安全隔离原则**
```
一个密钥泄露 ≠ 所有系统都被攻破
```

### 2. **具体风险场景**

#### 💻 设备丢失/被盗
- **相同密钥**：笔记本被盗 → 所有服务器都可能被访问
- **不同密钥**：笔记本被盗 → 只需撤销该设备的密钥

#### 🔓 密钥泄露
- **相同密钥**：一次泄露 → 影响所有系统
- **不同密钥**：一次泄露 → 影响范围可控

#### 🎯 针对性攻击
- **相同密钥**：攻击者获得持久化访问所有系统
- **不同密钥**：攻击者需要分别攻破每个系统

## ✅ 推荐的密钥管理策略

### 1. **密钥分类**

```nix
# 系统主机密钥 - 每个系统必须独立
woxQAQ-host = "ssh-ed25519 AAAAC3...";  # NixOS 主机密钥
woxMac-host = "ssh-ed25519 AAAAC3...";  # macOS 主机密钥

# 用户密钥 - 建议每个系统独立
woxQAQ-user = "ssh-ed25519 AAAAC3...";  # NixOS 用户密钥
woxMac-user = "ssh-ed25519 AAAAC3...";  # macOS 用户密钥

# 管理员密钥 - 独立的高权限密钥
admin-key = "ssh-ed25519 AAAAC3...";    # 紧急访问用
```

### 2. **访问控制矩阵**

| 密钥类型 | 用途 | 访问范围 | 安全级别 |
|---------|------|----------|----------|
| 系统主机密钥 | 系统级加密 | 单系统 | 🔴 高 |
| 用户密钥 | 日常操作 | 单系统 | 🟡 中 |
| 管理员密钥 | 紧急访问 | 跨系统 | 🔴 高 |

### 3. **实际部署步骤**

#### 步骤 1：为每个系统生成独立的用户密钥

```bash
# 在 woxQAQ (NixOS) 上
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_woxQAQ -C "woxQAQ@woxQAQ-system"

# 在 woxMac (macOS) 上  
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_woxMac -C "woxqaq@woxMac-system"

# 生成管理员密钥（在安全的环境中）
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519_admin -C "admin@emergency-access"
```

#### 步骤 2：更新 secrets.nix 中的公钥

```bash
# 获取公钥
cat ~/.ssh/id_ed25519_woxQAQ.pub
cat ~/.ssh/id_ed25519_woxMac.pub  
cat ~/.ssh/id_ed25519_admin.pub
```

#### 步骤 3：配置 SSH 客户端

```bash
# ~/.ssh/config
Host woxQAQ
    HostName your-nixos-host
    User woxQAQ
    IdentityFile ~/.ssh/id_ed25519_woxQAQ

Host woxMac
    HostName your-macos-host  
    User woxqaq
    IdentityFile ~/.ssh/id_ed25519_woxMac
```

## 🛡️ 密钥轮换策略

### 定期轮换计划
- **用户密钥**：每 6-12 个月
- **管理员密钥**：每 3-6 个月  
- **系统主机密钥**：每年或系统重装时

### 紧急轮换触发条件
- 设备丢失/被盗
- 怀疑密钥泄露
- 员工离职（如果是共享环境）
- 安全审计发现问题

## 🔍 审计和监控

### 1. **定期审计**
```bash
# 列出所有授权的密钥
agenix -d secret-name.age

# 检查系统上的密钥
ls -la ~/.ssh/
```

### 2. **访问日志监控**
- 监控 SSH 登录日志
- 设置异常访问告警
- 记录密钥使用情况

## 💡 便利性与安全性的平衡

### 如果你仍希望使用共享密钥：

1. **缩短轮换周期**（建议每月轮换）
2. **加强监控**（实时日志分析）
3. **限制密钥的使用范围**（只用于低敏感度操作）
4. **使用硬件安全密钥**（如 YubiKey）

### 推荐的渐进式迁移：

1. **立即**：确保系统主机密钥独立
2. **第一周**：为新密钥建立独立的用户密钥
3. **第二周**：迁移敏感操作到新密钥
4. **第三周**：停用旧的共享密钥

## 🎯 总结

**最安全的做法**：每个系统使用完全独立的密钥
**可接受的做法**：系统主机密钥独立，用户密钥根据风险评估决定
**不推荐的做法**：所有系统使用相同的密钥

记住：**安全是一个持续的过程，不是一次性的设置** 🔐 